name: CF KV Admin (put/get/delete/list)

on:
  workflow_dispatch:
    inputs:
      action:
        description: "put / get / delete / list"
        required: true
        default: "put"
      key:
        description: "KV key (e.g., cfg:APP)"
        required: false
        default: "cfg:APP"
      value:
        description: "Value for 'put' (paste JSON here)"
        required: false
        default: ""

jobs:
  kv-admin:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Wrangler v4
        run: npm i -g wrangler@4

      - name: Whoami (sanity)
        run: wrangler whoami
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}

      - name: Run KV action
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          set -e

          ACTION="${{ github.event.inputs.action }}"
          KEY="${{ github.event.inputs.key }}"
          VAL="${{ github.event.inputs.value }}"

          echo "Action: $ACTION"
          if [ "$ACTION" = "put" ]; then
            if [ -z "$KEY" ]; then
              echo "Error: key is required for put"; exit 1
            fi
            # 값이 멀티라인 JSON이어도 안전하게 처리
            printf "%s" "$VAL" > value.json

            echo "Putting to KV: $KEY"
            wrangler kv key put --binding=FCANEWS_KV "$KEY" "$(cat value.json)"

            echo "Verifying..."
            wrangler kv key get --binding=FCANEWS_KV "$KEY" || true

          elif [ "$ACTION" = "get" ]; then
            if [ -z "$KEY" ]; then
              echo "Error: key is required for get"; exit 1
            fi
            wrangler kv key get --binding=FCANEWS_KV "$KEY" || true

          elif [ "$ACTION" = "delete" ]; then
            if [ -z "$KEY" ]; then
              echo "Error: key is required for delete"; exit 1
            fi
            wrangler kv key delete --binding=FCANEWS_KV "$KEY" || true
            echo "Deleted (if existed)."

          elif [ "$ACTION" = "list" ]; then
            wrangler kv key list --binding=FCANEWS_KV || true

          else
            echo "Unknown action: $ACTION"; exit 1
          fi
