name: CF KV Reset (last_* keys)

on:
  workflow_dispatch: {}   # Actions 탭에서 수동 실행

jobs:
  reset-kv:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Wrangler v4
        run: npm i -g wrangler@4

      # toml에 account_id를 직접 넣지 않았다면, 아래 env로 주입하고
      # wrangler.toml에 account_id = "${{ env.CF_ACCOUNT_ID }}" 형태여야 합니다.
      - name: Delete last_sent_target_iso
        run: wrangler kv:key delete --binding=FCANEWS_KV last_sent_target_iso || true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}

      - name: Delete last_checked_time_iso
        run: wrangler kv:key delete --binding=FCANEWS_KV last_checked_time_iso || true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}

      - name: List keys (verify)
        run: wrangler kv:key list --binding=FCANEWS_KV
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
